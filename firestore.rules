
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPERS ---
    
    // Check if user is logged in
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user is accessing their own data
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Check if user has ADMIN role in their user profile
    function isAdmin() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMIN';
    }

    // --- USERS COLLECTION ---
    match /users/{userId} {
      // Users can read/write their own profile; Admins can manage all
      allow read: if isOwner(userId) || isAdmin();
      allow write: if isOwner(userId) || isAdmin();
    }

    // --- TRADE JOURNAL ---
    match /tradeJournal/{entryId} {
      // Users manage their own entries
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow read, update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // --- ANALYSIS HISTORY ---
    match /analysisHistory/{analysisId} {
      // Users save their analysis; Admins can read for oversight
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      // Users can only update feedback field
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid 
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['feedback']);
    }

    // --- EDUCATION HISTORY ---
    match /educationHistory/{historyId} {
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
    }

    // --- SIGNALS (Admin Manageable) ---
    match /signals/{signalId} {
      // Everyone can read active signals
      allow read: if isAuthenticated();
      // Only Admin can manage lifecycle explicitly
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // --- EDUCATION CONTENT (Admin Manageable) ---
    match /educationContent/{contentId} {
      // Everyone can read lessons, only Admin can create/edit
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // --- SYSTEM CONFIG (Admin Only) ---
    match /system_config/{configId} {
      allow read, write: if isAdmin();
    }

    // --- ADMIN AUDIT LOGS (Admin Only) ---
    match /admin_audit_logs/{logId} {
      allow read, write: if isAdmin();
    }

    // --- ADMIN ANALYTICS (Admin Read-Only) ---
    match /admin_analytics_daily/{date} {
      allow read: if isAdmin();
    }
    match /admin_analytics_overall/{summary} {
      allow read: if isAdmin();
    }

    // --- TOKEN TRANSACTIONS ---
    match /token_transactions/{transId} {
      // Users can see their own transactions, Admins see all
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      // System (via client SDK for refills) or Admin (for grants) can create
      allow create: if isAuthenticated() && (request.resource.data.userId == request.auth.uid || isAdmin());
    }

    // --- GLOBAL DENY ---
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
